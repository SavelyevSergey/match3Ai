# 2. Основной геймплей

[◀ Назад к оглавлению](README.md) | [▶ Следующий раздел: Алгоритмы и системы](03_Алгоритмы_и_системы.md)

---

## 2.1. Базовая механика Match-3

### 2.1.1. Правила составления комбинаций

- **Минимальная комбинация:** 3 одинаковых элемента подряд
- **Расширенные комбинации:**
  - 4 в ряд (горизонталь/вертикаль)
  - 5 в ряд (горизонталь/вертикаль)
  - L-образная форма (3+2)
  - T-образная форма (3+3)
  - Крест (2+3+2)

### 2.1.2. Математические правила определения совпадений

```
Match = {elements | ∀e ∈ elements: e.type == type ∧ Adjacent(elements) ∧ |elements| ≥ 3}

Adjacent(elements):
  - Для горизонтали: elements[i].x == elements[i+1].x - 1 ∧ elements[i].y == elements[i+1].y
  - Для вертикали: elements[i].y == elements[i+1].y - 1 ∧ elements[i].x == elements[i+1].x
```

### 2.1.3. Типы ходов

- **Свайп (Swipe):** перемещение элемента на соседнюю клетку (4 направления: вверх, вниз, влево, вправо)
- **Тап (Tap):** активация специальных элементов
- **Условия валидности хода:**
  - Обмен возможен только с соседними клетками
  - После обмена должна образоваться минимум одна комбинация из 3+ элементов
  - Нельзя менять элементы с пустыми клетками или заблокированными областями

### 2.1.4. Порядок обработки совпадений

1. Проверка вертикальных совпадений
2. Проверка горизонтальных совпадений
3. Объединение пересекающихся групп (для L, T, крестообразных форм)
4. Определение типа создаваемого бустера (если применимо)

### 2.1.5. Гравитация и заполнение поля

**Последовательность операций:**
1. Уничтожение совпавших элементов
2. Падение элементов вниз (покадрово или мгновенно - параметр настройки)
3. Генерация новых элементов сверху
4. Повторная проверка совпадений (каскад)
5. Если есть новые совпадения → возврат к шагу 1

**Правила падения:**
- Элементы падают вертикально вниз до первого препятствия или края поля
- Если под элементом несколько пустых клеток, он падает в самую нижнюю
- Порядок падения: слева направо, снизу вверх (или настраиваемый параметр)

**Генерация новых элементов:**
- Новые элементы появляются сверху поля
- Количество: равно количеству пустых клеток в каждом столбце
- Weighted Random на основе текущих целей уровня (см. раздел 3.2)

### 2.1.6. Каскадные падения

- **Комбо-счётчик:** увеличивается с каждым автоматическим матчем
- **Множитель очков:** Score_multiplier = 1.0 + (combo_count × 0.1)
- **Максимальная глубина каскада:** не ограничена (зависит от настроек производительности)

### 2.1.7. Edge Cases (особые ситуации)

- **Одновременные комбинации:** если ход создаёт несколько независимых матчей, они обрабатываются одновременно
- **Пересекающиеся комбинации:** элемент может входить в горизонтальную И вертикальную комбинацию → создаётся более мощный бустер
- **Deadlock:** нет возможных ходов → автоматическое перемешивание (см. раздел 2.5.3)

---

## 2.2. Специальные элементы (Бустеры)

### 2.2.1. Типы бустеров и условия создания

| Тип бустера | Условие создания | Эффект | Радиус действия |
|-------------|-----------------|--------|-----------------|
| **Полосатая конфета (Striped)** | 4 в ряд (гор./верт.) | Уничтожает линию (направление зависит от ориентации матча) | Вся строка или столбец |
| **Обёрнутая конфета (Wrapped)** | L или T форма | Взрыв в области | 3×3 клетки |
| **Цветная бомба (Color Bomb)** | 5 в ряд | Уничтожает все элементы выбранного цвета | Всё поле |
| **Радужный элемент (Rainbow)** | Комбинация двух бустеров | Специальный эффект (см. таблицу комбинаций) | Зависит от комбинации |

### 2.2.2. Механика активации

- **Полосатая/Обёрнутая:** автоматическая активация при участии в матче
- **Цветная бомба:** активация при свапе с любым обычным элементом
- **Ручная активация:** двойной тап на бустере (опционально)

### 2.2.3. Таблица комбинаций бустеров

| Комбинация | Результат | Радиус | Урон препятствиям |
|------------|-----------|--------|-------------------|
| Striped + Striped | Крест (вертикаль + горизонталь) | Строка + столбец | 2 |
| Wrapped + Wrapped | Мега-взрыв | 5×5 | 3 |
| Striped + Wrapped | Тройная линия (3 строки или 3 столбца) | 3 линии | 2 |
| Color Bomb + Color Bomb | Очистка всего поля | Всё поле | 5 |
| Color Bomb + Striped | Все элементы цвета превращаются в Striped и активируются | Всё поле | 3 |
| Color Bomb + Wrapped | Все элементы цвета превращаются в Wrapped и активируются | Всё поле | 3 |
| Color Bomb + обычный элемент | Уничтожение всех элементов этого типа | Всё поле | 1 |

### 2.2.4. Последовательность активации эффектов

1. Определение комбинации бустеров
2. Маркировка всех элементов, попадающих под действие
3. Одновременное уничтожение всех отмеченных элементов
4. Нанесение урона препятствиям в радиусе действия
5. Активация Chain Reaction (если уничтоженные элементы содержат бустеры)

### 2.2.5. Damage Values

- **Обычный матч рядом с препятствием:** 1 урон
- **Striped через препятствие:** 2 урона
- **Wrapped взрыв:** 2 урона в радиусе 3×3
- **Color Bomb:** 1 урон всем препятствиям на поле
- **Комбо-бустеры:** см. таблицу выше

---

## 2.3. Препятствия и блокеры

### 2.3.1. Таблица препятствий

| Тип | HP | Условия получения урона | Блокирует перемещение | Блокирует падение | Может содержать элемент |
|-----|----|-----------------------|---------------------|------------------|----------------------|
| **Лёд (Ice)** | 1-3 слоя | Матч рядом (Adjacent) | Нет | Нет | Да (элемент внутри льда) |
| **Камень (Stone)** | 1-2 слоя | Прямое попадание (Direct hit) или взрыв | Да | Да | Нет |
| **Цепь (Chain)** | 1 | Любой матч на этой клетке | Да | Нет | Да (блокирует движение элемента) |
| **Желе (Jelly)** | 1-2 слоя | Матч на этой клетке | Нет | Нет | Да |
| **Коробка (Box)** | 1 | Матч рядом (4 направления) | Да | Да | Нет |
| **Генератор (Spawner)** | ∞ (неуничтожим) | — | Да | Нет | Нет (генерирует препятствия) |

### 2.3.2. Механика разрушения

**Adjacency (соседство):**
- 4-направленное: вверх, вниз, влево, вправо
- 8-направленное: + 4 диагонали (опционально, для некоторых препятствий)

**Direct hit (прямое попадание):**
- Элемент находится точно на клетке с препятствием
- Применяется для элементов внутри льда/желе/цепей

**Урон от бустеров:**
- Striped наносит урон всем препятствиям на линии
- Wrapped наносит урон в радиусе 3×3
- Color Bomb наносит 1 урон всем препятствиям типа

### 2.3.3. Многослойные препятствия

**Последовательность удаления:**
1. Получение урона → уменьшение HP на 1
2. Визуальное изменение (трещины, изменение цвета)
3. При HP = 0 → полное удаление
4. Если препятствие содержало элемент → элемент освобождается

**Пример: Лёд 3 слоя**
- 1 урон → Лёд 2 слоя (видны трещины)
- 1 урон → Лёд 1 слой (больше трещин)
- 1 урон → Лёд уничтожен, элемент свободен

### 2.3.4. Влияние на гравитацию

- **Блокирует падение (Stone, Box):** элементы не могут упасть на эту клетку
- **Не блокирует (Ice, Jelly, Chain):** элементы могут находиться на клетке и участвовать в матчах
- **Генератор:** периодически создаёт новые препятствия (частота: 1 раз в N ходов)

### 2.3.5. Приоритеты при комбинированном уроне

Если клетка получает урон из нескольких источников одновременно:
1. Суммирование урона: Total_damage = Σ(damage_sources)
2. Применение к HP препятствия: HP -= Total_damage
3. Максимальный урон за ход ограничен HP препятствия (overkill не переносится на другие препятствия)

---

## 2.4. Типы уровней

### 2.4.1. Сбор элементов (Collection)

**Win Condition:**
```
Win = ∀ target ∈ Targets: collected[target.type] ≥ target.amount ∧ moves_remaining ≥ 0
```

**Логика:**
- Подсчёт уничтоженных элементов каждого типа
- Прогресс отображается в UI
- Элементы, используемые для создания бустеров, также засчитываются

**Генерация нужных элементов:**
- Weighted random с повышенной вероятностью для целевых типов
- Weight_target = base_weight × (1 + progress_multiplier)
- progress_multiplier = max(0, (target_amount - collected) / target_amount)

### 2.4.2. Очистка поля от препятствий (Clear the Board)

**Win Condition:**
```
Win = ∀ obstacle ∈ Obstacles: obstacle.HP == 0 ∧ moves_remaining ≥ 0
```

**Логика:**
- Подсчёт оставшихся препятствий
- Проверка после каждого хода
- Некоторые препятствия могут быть скрыты под другими

### 2.4.3. Доставка ингредиентов вниз (Drop Ingredients)

**Win Condition:**
```
Win = ∀ ingredient ∈ Ingredients: ingredient.y == bottom_row ∧ moves_remaining ≥ 0
```

**Логика:**
- Ингредиенты - специальные элементы, которые не участвуют в матчах
- Падают вниз по специальным путям (заранее размеченным выходам)
- Pathfinding: поиск кратчайшего пути до выхода при каждом падении
- Если путь заблокирован препятствиями → ингредиент ожидает освобождения

**Алгоритм движения ингредиентов:**
1. Проверка клетки снизу
2. Если свободна → падение
3. Если занята → проверка диагоналей (приоритет: вниз-влево, вниз-вправо)
4. Если все пути заблокированы → ожидание
5. При достижении нижнего ряда → проверка наличия выхода

### 2.4.4. Набор очков за ограниченное количество ходов (Score Target)

**Win Condition:**
```
Win = current_score ≥ target_score ∧ moves_remaining ≥ 0
```

**Логика:**
- Начисление очков за каждый матч (см. раздел 3.3)
- Бонусы за комбо и бустеры
- Прогресс-бар для визуализации

**Формула базовых очков:**
```
Base_score = matched_elements_count × element_base_value × combo_multiplier
```

### 2.4.5. Комбинированные цели (Mixed Objectives)

**Win Condition:**
```
Win = objective_1 ∧ objective_2 ∧ ... ∧ objective_n ∧ moves_remaining ≥ 0
```

**Примеры:**
- Собрать 20 красных элементов И набрать 5000 очков
- Очистить все желе И доставить 3 ингредиента
- Набрать 10000 очков И уничтожить все камни

### 2.4.6. Проверка достижимости цели (Solvability)

**Алгоритм:**
1. Simulation run: проверка возможности достижения цели при идеальной игре
2. Параметры:
   - Минимальное количество ходов для win
   - Вероятность случайного решения (должна быть > 1%)
3. Если уровень нерешаем → автоматическая корректировка параметров

---

[◀ Предыдущий раздел: Концепция и видение](01_Концепция_и_видение.md) | [▶ Следующий раздел: Алгоритмы и системы](03_Алгоритмы_и_системы.md)
