# 4. Техническая специфика ⭐

[◀ Назад к оглавлению](README.md) | [▶ Следующий раздел: Прогрессия и сложность](05_Прогрессия_и_сложность.md)

**Критически важно для разработчика механик**

---
### 2.6. Техническая специфика ⭐ НОВЫЙ РАЗДЕЛ

#### 2.6.1. Состояния игры (Game State Machine)

**Основные состояния:**
```csharp
public enum GameState
{
    Initialization,    // Инициализация уровня
    Idle,             // Ожидание ввода игрока
    PlayerInput,      // Обработка ввода (свайп/тап)
    SwapAnimation,    // Анимация обмена элементов
    ValidatingSwap,   // Проверка валидности хода
    InvalidSwap,      // Откат невалидного хода
    MatchChecking,    // Поиск совпадений
    Destroying,       // Уничтожение элементов
    Falling,          // Падение элементов
    Spawning,         // Создание новых элементов
    CascadeCheck,     // Проверка каскадных матчей
    BonusCalculation, // Расчёт бонусов за оставшиеся ходы
    LevelComplete,    // Уровень завершён (победа)
    LevelFailed,      // Уровень провален (поражение)
    GameOver          // Конец игровой сессии
}
```

**Диаграмма переходов:**
```
Initialization
    ↓
Idle ←──────────────────┐
    ↓                    │
PlayerInput              │
    ↓                    │
SwapAnimation            │
    ↓                    │
ValidatingSwap           │
    ├─→ InvalidSwap ─────┘ (откат)
    ↓
MatchChecking
    ├─→ (no matches) ────┘
    ↓
Destroying
    ↓
Falling
    ↓
Spawning
    ↓
CascadeCheck
    ├─→ (matches found) → MatchChecking
    ├─→ (no matches, moves left) → Idle
    ├─→ (objectives complete) → BonusCalculation → LevelComplete
    └─→ (no moves left) → LevelFailed
```

#### 2.6.2. Timing и порядок операций

**Последовательность хода игрока:**
```
1. PlayerInput (0.0s)
   ↓
2. SwapAnimation (0.3s)
   ↓
3. ValidatingSwap (0.0s - instant check)
   ├─→ Valid: continue
   └─→ Invalid: InvalidSwap (0.3s reverse animation) → Idle
   ↓
4. MatchChecking (0.0s - instant)
   ↓
5. Destroying (0.4s - элементы исчезают)
   ↓
6. Falling (0.5s - элементы падают)
   ↓
7. Spawning (0.3s - новые элементы появляются)
   ↓
8. CascadeCheck (0.1s delay)
   ↓
9. Repeat 4-8 until no matches
   ↓
10. Return to Idle
```

**Параметры задержек (настраиваемые):**
```csharp
public class TimingConfig
{
    public float swapDuration = 0.3f;
    public float destroyDuration = 0.4f;
    public float fallDuration = 0.5f;
    public float spawnDuration = 0.3f;
    public float cascadeDelay = 0.1f;
    public float boosterActivationDelay = 0.2f;
}
```

**Animation Completion Tracking:**
```csharp
public class AnimationTracker
{
    private int activeAnimations = 0;
    
    public void RegisterAnimation()
    {
        activeAnimations++;
    }
    
    public void CompleteAnimation()
    {
        activeAnimations--;
        if (activeAnimations == 0)
            OnAllAnimationsComplete?.Invoke();
    }
    
    public bool IsAnimating => activeAnimations > 0;
}
```

#### 2.6.3. Валидация и вспомогательные системы

**Проверка возможных ходов (Hint System):**
```
function FindPossibleMoves(grid):
    possible_moves = []
    
    for each cell in grid:
        for each direction in [Up, Down, Left, Right]:
            neighbor = GetNeighbor(cell, direction)
            if CanSwap(cell, neighbor):
                SimulateSwap(cell, neighbor)
                if HasMatches():
                    possible_moves.add((cell, neighbor))
                UndoSwap(cell, neighbor)
    
    return possible_moves
```

**Hint система:**
- Автоматическое предложение хода после N секунд бездействия (N = 5-10)
- Визуальная подсветка (мерцание) одного из возможных ходов
- Приоритет: ходы с максимальным потенциалом (бустеры > обычные матчи)

**Валидация хода перед обработкой:**
```csharp
public bool IsValidMove(Cell from, Cell to)
{
    // Проверка 1: соседние клетки
    if (!AreNeighbors(from, to))
        return false;
    
    // Проверка 2: обе клетки доступны
    if (!from.isAvailable || !to.isAvailable)
        return false;
    
    // Проверка 3: обе клетки содержат элементы
    if (from.element == null || to.element == null)
        return false;
    
    // Проверка 4: не заблокированы препятствиями
    if (from.IsBlocked() || to.IsBlocked())
        return false;
    
    // Проверка 5: симуляция создаёт матч
    Swap(from, to);
    bool hasMatch = HasMatchAt(from) || HasMatchAt(to);
    Swap(to, from); // откат
    
    return hasMatch;
}
```

**Особые случаи валидации:**
- Обмен с бустерами (Color Bomb + любой элемент = всегда валиден)
- Обмен с заблокированными клетками (цепи, замороженные элементы)
- Обмен на клетках с генераторами (запрещён)

#### 2.6.4. Оптимизация производительности

**Object Pooling:**
- Пул элементов: переиспользование GameObjects вместо Instantiate/Destroy
- Пул частиц: эффекты взрывов, искр и т.д.
- Пул UI элементов: счётчики очков, индикаторы

**Update оптимизация:**
- Избегать поиска компонентов в Update (кэшировать ссылки)
- Использовать Coroutines для анимаций вместо Update
- State Machine обновляется только при смене состояния

**Memory Management:**
- Избегать new в Update/FixedUpdate
- Использовать struct для данных, где возможно
- Предварительная аллокация коллекций

#### 2.6.5. События и архитектура

**Event System:**
```csharp
public class GameEvents
{
    public static event Action<Cell, Cell> OnSwapAttempt;
    public static event Action<List<Cell>> OnMatchFound;
    public static event Action<Cell> OnElementDestroyed;
    public static event Action<int> OnScoreChanged;
    public static event Action<int> OnMoveMade;
    public static event Action OnLevelComplete;
    public static event Action OnLevelFailed;
    public static event Action OnNoMovesLeft;
}
```

**Разделение ответственности:**
- **GridManager:** управление сеткой, клетками
- **MatchManager:** обнаружение совпадений (BFS)
- **InputManager:** обработка свайпов/тапов
- **AnimationManager:** управление анимациями и таймингами
- **ObjectiveManager:** отслеживание целей уровня
- **ScoreManager:** подсчёт очков
- **BoosterManager:** создание и активация бустеров

---

[◀ Предыдущий раздел: Алгоритмы и системы](03_Алгоритмы_и_системы.md) | [▶ Следующий раздел: Прогрессия и сложность](05_Прогрессия_и_сложность.md)
